import socket
from multiprocessing import Process
import sys


def clientHandler(clientSocket, clientAddr):
    isConnected = True
    while isConnected:
        data = clientSocket.recv(1024)
        if data:
            clientSocket.send(data)
        else:
            clientIp, clientPort = clientAddr
            print(f"Client :{clientIp}:{clientPort} left ")
            clientSocket.close()
            isConnected = False


server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
server.bind(('', int(sys.argv[1]))) 
#server.bind(('', 3333)) 
server.listen(10)  # listen(10) escutando no maximo 10 conexoes
while True:
    # Enquanto skt.accept() nao recebe conexao ele espera.
    clientSocket, addr = server.accept()
    clientIp, clientPort = addr
    print(f"New client connected from {clientIp}:{clientPort}")
    threading.Thread(target=clientHandler, args=(clientSocket, addr)).start()
